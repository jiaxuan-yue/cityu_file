{% extends "base.html" %}
{% block title %}User Panel - {{ username }}{% endblock %}
{% block header %}User Panel - {{ username }}{% endblock %}
{% block header_button %}
<a href="{{ url_for('index') }}"><button style="float:right;">Return to Coding Review</button></a>
{% endblock %}

{% block content %}
<div class="center-section" style="text-align:center;">
    <h2>My Tasks</h2>
    {% if tasks %}
    <table style="margin:0 auto; border-collapse: collapse; width:80%;">
        <thead>
            <tr style="background: linear-gradient(to right, #4a90e2, #00aaff); color:white;">
                <th style="padding:10px; border:1px solid #ccc;">ID</th>
                <th style="padding:10px; border:1px solid #ccc;">Task Name</th>
                <th style="padding:10px; border:1px solid #ccc;">Priority</th>
                <th style="padding:10px; border:1px solid #ccc;">Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for task in tasks %}
            <tr>
                <td style="padding:10px; border:1px solid #ccc;">{{ task.id }}</td>
                <td style="padding:10px; border:1px solid #ccc;">{{ task.title }}</td>
                <td style="padding:10px; border:1px solid #ccc;">
                    {% if task.priority == 1 %}<span style="color:red;">{{ task.priority }}</span>
                    {% elif task.priority == 2 %}<span style="color:orange;">{{ task.priority }}</span>
                    {% else %}{{ task.priority }}{% endif %}
                </td>
                <td style="padding:10px; border:1px solid #ccc;">
                    {% set priority_req = requests 
                        | selectattr('username','equalto',username) 
                        | selectattr('task_id','equalto',task.id) 
                        | selectattr('request_type','equalto','priority') 
                        | selectattr('status','equalto','pending') | list %}
                    {% set delete_req = requests 
                        | selectattr('username','equalto',username) 
                        | selectattr('task_id','equalto',task.id) 
                        | selectattr('request_type','equalto','delete') 
                        | selectattr('status','equalto','pending') | list %}

                    <button 
                        onclick="sendRequest('{{ username }}','{{ task.id }}','priority', this)"
                        style="margin:5px; padding:8px 15px; border-radius:10px; border:none; color:white; background: linear-gradient(to right, #4a90e2, #00aaff); cursor:pointer;"
                        {% if priority_req %}disabled style="background:#ccc; cursor:not-allowed;"{% endif %}>
                        Request Priority Change
                    </button>

                    <button
                        onclick="sendRequest('{{ username }}','{{ task.id }}','delete', this)"
                        style="margin:5px; padding:8px 15px; border-radius:10px; border:none; color:white; background: linear-gradient(to right, #4a90e2, #00aaff); cursor:pointer;"
                        {% if delete_req %}disabled style="background:#ccc; cursor:not-allowed;"{% endif %}>
                        Request Task Deletion
                    </button>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    {% else %}
        <p>No tasks assigned currently</p>
    {% endif %}
</div>

<script>
function sendRequest(username, task_id, type, btn) {
    fetch(`/tickets/user/request_${type}/${username}/${task_id}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 禁用按钮
            btn.disabled = true;
            btn.style.background = '#ccc';
            btn.style.cursor = 'not-allowed';
        } else {
            alert('Request failed');
        }
    })
    .catch(err => alert('Request error: ' + err));
}
</script>
{% endblock %}
